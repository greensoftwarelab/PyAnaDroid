

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>anadroid.build.GradleBuilder &mdash; pyanadroid 0.3.5 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> pyanadroid
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">pyanadroid</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>anadroid.build.GradleBuilder</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for anadroid.build.GradleBuilder</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">copy</span>

<span class="kn">from</span> <span class="nn">manafa.utils.Logger</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span> <span class="n">LogSeverity</span>
<span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
<span class="kn">from</span> <span class="nn">textops</span> <span class="kn">import</span> <span class="n">grep</span><span class="p">,</span> <span class="n">cat</span><span class="p">,</span> <span class="n">sed</span><span class="p">,</span> <span class="n">head</span><span class="p">,</span> <span class="n">echo</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">anadroid.application.AndroidProject</span> <span class="kn">import</span> <span class="n">BUILD_TYPE</span>
<span class="kn">from</span> <span class="nn">anadroid.application.Application</span> <span class="kn">import</span> <span class="n">App</span>
<span class="kn">from</span> <span class="nn">anadroid.application.Dependency</span> <span class="kn">import</span> <span class="n">DependencyType</span>
<span class="kn">from</span> <span class="nn">anadroid.build.AbstractBuilder</span> <span class="kn">import</span> <span class="n">AbstractBuilder</span>
<span class="kn">from</span> <span class="nn">anadroid.build.versionUpgrader</span> <span class="kn">import</span> <span class="n">DefaultSemanticVersion</span><span class="p">,</span> <span class="n">can_be_semantic_version</span>
<span class="kn">from</span> <span class="nn">anadroid.utils.Utils</span> <span class="kn">import</span> <span class="n">mega_find</span><span class="p">,</span> <span class="n">execute_shell_command</span><span class="p">,</span> <span class="n">sign_apk</span><span class="p">,</span> <span class="n">log_to_file</span><span class="p">,</span> <span class="n">loge</span><span class="p">,</span> <span class="n">logw</span>
<span class="kn">from</span> <span class="nn">anadroid.build.GracleBuildErrorSolver</span> <span class="kn">import</span> <span class="n">is_known_error</span><span class="p">,</span> <span class="n">solve_known_error</span>

<span class="n">TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;implementation&quot;</span>
<span class="n">TEST_TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;testImplementation&quot;</span>
<span class="n">ANDROID_TEST_TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;androidTestImplementation&quot;</span>
<span class="n">DEBUG_TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;debugImplementation&quot;</span>

<span class="n">TEST_RUNNERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;android.test.InstrumentationTestRunner&#39;</span><span class="p">:</span> <span class="mi">22</span><span class="p">,</span>
    <span class="s1">&#39;android.support.test.runner.AndroidJUnitRunner&#39;</span><span class="p">:</span> <span class="mi">28</span><span class="p">,</span>
    <span class="s1">&#39;androidx.test.runner.AndroidJUnitRunner&#39;</span><span class="p">:</span> <span class="mi">32</span>
<span class="p">}</span>

<span class="n">LOCAL_PROPERTIES_FLAGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;android.enableBuildCache&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
    <span class="s1">&#39;org.gradle.caching&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">LINT_ISSUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;Recycle&#39;</span><span class="p">,</span> <span class="s1">&#39;Wakelock&#39;</span><span class="p">,</span> <span class="s1">&#39;DrawAllocation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ObsoleteLayoutParam&#39;</span><span class="p">,</span> <span class="s1">&#39;ViewHolder&#39;</span><span class="p">}</span>

<span class="n">DEX_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;preDexLibraries&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
    <span class="s1">&#39;javaMaxHeapSize&#39;</span><span class="p">:</span> <span class="s1">&#39;&quot;4g&quot;&#39;</span>
<span class="p">}</span>

<span class="n">LINT_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;abortOnError&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ATTRIBS_NAME_REMAPS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;packageName&#39;</span><span class="p">:</span> <span class="s1">&#39;applicationId&#39;</span><span class="p">,</span>
    <span class="s1">&#39;testPackageName&#39;</span><span class="p">:</span> <span class="s1">&#39;testApplicationId&#39;</span><span class="p">,</span>
    <span class="s1">&#39;packageNameSuffix&#39;</span><span class="p">:</span> <span class="s1">&#39;applicationIdSuffix&#39;</span><span class="p">,</span>
    <span class="s1">&#39;android.plugin.bootClasspath&#39;</span><span class="p">:</span> <span class="s1">&#39;android.bootClasspath&#39;</span><span class="p">,</span>
    <span class="s1">&#39;android.plugin.ndkFolder&#39;</span><span class="p">:</span> <span class="s1">&#39;android.plugin.ndkDirectory &#39;</span><span class="p">,</span>
    <span class="s1">&#39;zipAlign&#39;</span><span class="p">:</span> <span class="s1">&#39;zipAlignEnabled&#39;</span><span class="p">,</span>
    <span class="s1">&#39;jniDebugBuild&#39;</span><span class="p">:</span> <span class="s1">&#39;jniDebuggable&#39;</span><span class="p">,</span>
    <span class="s1">&#39;renderscriptDebug&#39;</span><span class="p">:</span> <span class="s1">&#39;renderscriptDebuggable&#39;</span><span class="p">,</span>
    <span class="s1">&#39;flavorGroups&#39;</span><span class="p">:</span> <span class="s1">&#39;flavorDimensions&#39;</span><span class="p">,</span>
    <span class="s1">&#39;renderscriptSupportMode&#39;</span><span class="p">:</span> <span class="s1">&#39;renderscriptSupportModeEnabled&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ProductFlavor.renderscriptNdkMode&#39;</span><span class="p">:</span> <span class="s1">&#39;renderscriptNdkModeEnabled&#39;</span><span class="p">,</span>
    <span class="s1">&#39;InstrumentTest&#39;</span><span class="p">:</span> <span class="s1">&#39;androidTest&#39;</span><span class="p">,</span>
    <span class="s1">&#39;instrumentTestCompile&#39;</span><span class="p">:</span> <span class="s1">&#39;jniDebuggable&#39;</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">BUILD_RESULTS_FILE</span> <span class="o">=</span> <span class="s2">&quot;buildStatus.json&quot;</span>
<span class="n">SUCCESS_VALUE</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
<span class="n">BUILD_SUCCESS_VALUE</span> <span class="o">=</span> <span class="s2">&quot;BUILD SUCCESSFUL&quot;</span>
<span class="n">DEFAULT_BUILD_TIMES_TO_TRY</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">DEFAULT_BUILD_TOOLS_VERSION</span> <span class="o">=</span> <span class="s1">&#39;25.0.3&#39;</span><span class="c1"># TODO</span>


<div class="viewcode-block" id="gen_dependency_string"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.gen_dependency_string">[docs]</a><span class="k">def</span> <span class="nf">gen_dependency_string</span><span class="p">(</span><span class="n">dependency</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;generates dependency format to be inserted in gradle files.</span>
<span class="sd">    Args:</span>
<span class="sd">        dependency(obj: `BuildDependency`): dependency.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dependency_string(str): dependency format as string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">dependency</span><span class="o">.</span><span class="n">dep_type</span> <span class="o">==</span> <span class="n">DependencyType</span><span class="o">.</span><span class="n">LOCAL_BINARY</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span><span class="si">{transitive}</span><span class="s2"> (name:&#39;</span><span class="si">{name}</span><span class="s2">&#39;, ext:&#39;</span><span class="si">{tp}</span><span class="s2">&#39;)&quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitive</span><span class="o">=</span><span class="n">TRANSITIVE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                                     <span class="n">tp</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">bin_type</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dependency</span><span class="o">.</span><span class="n">dep_type</span> <span class="o">==</span> <span class="n">DependencyType</span><span class="o">.</span><span class="n">LOCAL_MODULE</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{transitive}</span><span class="s2"> project(:</span><span class="si">{name}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitive</span><span class="o">=</span><span class="n">TRANSITIVE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dependency</span><span class="o">.</span><span class="n">dep_type</span> <span class="o">==</span> <span class="n">DependencyType</span><span class="o">.</span><span class="n">CLASSPATH</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;classpath &#39;</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> \
               <span class="o">+</span> <span class="s2">&quot;:</span><span class="si">{version}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="k">if</span> <span class="n">dependency</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&#39;&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{transitive}</span><span class="s2"> &#39;</span><span class="si">{name}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">transitive</span><span class="o">=</span><span class="n">TRANSITIVE</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> \
               <span class="o">+</span> <span class="s2">&quot;:</span><span class="si">{version}</span><span class="s2">&#39;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">version</span><span class="o">=</span><span class="n">dependency</span><span class="o">.</span><span class="n">version</span><span class="p">)</span> <span class="k">if</span> <span class="n">dependency</span><span class="o">.</span><span class="n">version</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;&#39;&quot;</span></div>


<div class="viewcode-block" id="set_transitive_names"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.set_transitive_names">[docs]</a><span class="k">def</span> <span class="nf">set_transitive_names</span><span class="p">(</span><span class="n">gradle_plugin_version</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Given the gradle-plugin version, sets the most adequate nomenclature to use in dependencies definition.</span>
<span class="sd">    Args:</span>
<span class="sd">        gradle_plugin_version: gradle-plugin version.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">DefaultSemanticVersion</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">gradle_plugin_version</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">major</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
        <span class="k">global</span> <span class="n">TRANSITIVE</span>
        <span class="n">TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;compile&quot;</span>
        <span class="k">global</span> <span class="n">TEST_TRANSITIVE</span>
        <span class="n">TEST_TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;testCompile&quot;</span>
        <span class="k">global</span> <span class="n">ANDROID_TEST_TRANSITIVE</span>
        <span class="n">ANDROID_TEST_TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;AndroidTestCompile&quot;</span>
        <span class="k">global</span> <span class="n">DEBUG_TRANSITIVE</span>
        <span class="n">DEBUG_TRANSITIVE</span> <span class="o">=</span> <span class="s2">&quot;debugCompile&quot;</span></div>
        <span class="c1"># TODO api vs implementation vs compilonly ... https://developer.android.com/studio/build/dependencies#dependency_configurations</span>


<div class="viewcode-block" id="is_library_gradle"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.is_library_gradle">[docs]</a><span class="k">def</span> <span class="nf">is_library_gradle</span><span class="p">(</span><span class="n">bld_file</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;checks if bld_file is a build file from a library.</span>
<span class="sd">    Returns:</span>
<span class="sd">        bool: True if is a library, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39;com.android.library&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">bld_file</span><span class="p">))</span></div>


<div class="viewcode-block" id="GradleBuilder"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder">[docs]</a><span class="k">class</span> <span class="nc">GradleBuilder</span><span class="p">(</span><span class="n">AbstractBuilder</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class that extends AbstractBuilder functionality in order to build Gradle projects.</span>
<span class="sd">    Attributes:</span>
<span class="sd">        build_flags(dict): build flags.</span>
<span class="sd">        change_history(list): list of changes performed to project.</span>
<span class="sd">        gradle_plg_version(str): Gradle plugin version for proj.</span>
<span class="sd">        build_tools_version(str): Gradle version for proj.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">resources_dir</span><span class="p">,</span> <span class="n">instrumenter</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">GradleBuilder</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">proj</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="n">resources_dir</span><span class="p">,</span> <span class="n">instrumenter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_flags</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">change_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gradle_plg_version</span> <span class="o">=</span> <span class="n">proj</span><span class="o">.</span><span class="n">get_gradle_plugin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_tools_version</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">set_transitive_names</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gradle_plg_version</span><span class="p">)</span>

<div class="viewcode-block" id="GradleBuilder.build_proj_and_apk"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.build_proj_and_apk">[docs]</a>    <span class="k">def</span> <span class="nf">build_proj_and_apk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_type</span><span class="o">=</span><span class="n">BUILD_TYPE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">build_tests_apk</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;builds project and generates apk of build type. It can optionally build the tests apk and/or rebuild</span>
<span class="sd">        the current project in case it was already built.</span>
<span class="sd">        Args:</span>
<span class="sd">            build_type(BUILD_TYPE): type of build to perform.</span>
<span class="sd">            build_tests_apk(bool): True if the tests&#39; apk has to be generated, False otherwise.</span>
<span class="sd">            rebuild(bool): True if the current build has to be cleaned and rebuilt, False otherwise.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: build results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">rebuild</span><span class="o">=</span><span class="n">rebuild</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_apk</span><span class="p">(</span><span class="n">build_type</span><span class="o">=</span><span class="n">build_type</span><span class="p">)</span> \
               <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">set_version</span><span class="p">(</span><span class="n">build_type</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> \
               <span class="ow">and</span> <span class="p">(</span><span class="kc">True</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">build_tests_apk</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tests_apk</span><span class="p">())</span></div>

<div class="viewcode-block" id="GradleBuilder.install_apks"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.install_apks">[docs]</a>    <span class="k">def</span> <span class="nf">install_apks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_type</span><span class="o">=</span><span class="n">BUILD_TYPE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span> <span class="n">install_apk_test</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;install apk of build_type and optionally de tests apk.</span>
<span class="sd">        Args:</span>
<span class="sd">            build_type(BUILD_TYPE): build type.</span>
<span class="sd">            install_apk_test(bool): True if the tests&#39; apk has to be installed, False otherwise.</span>

<span class="sd">        Returns:</span>
<span class="sd">            apps_list(list): list of installed apks.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">apps_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">task_name</span> <span class="o">=</span> <span class="s2">&quot;install&quot;</span> <span class="o">+</span> <span class="n">build_type</span><span class="o">.</span><span class="n">value</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span>
        <span class="n">was_success</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">BUILD_SUCCESS_VALUE</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">was_success</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2">: SUCCESSFUL&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="n">app</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_app_from_installed_apk</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">build_type</span><span class="p">)</span>
            <span class="n">apps_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{task}</span><span class="s2">_</span><span class="si">{results}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task_name</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;SUCCESS&quot;</span> <span class="k">if</span> <span class="n">was_success</span> <span class="k">else</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">)))</span>
        <span class="n">log_to_file</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">install_apk_test</span><span class="p">:</span>
            <span class="n">task_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;install</span><span class="si">{</span><span class="n">build_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">AndroidTest&quot;</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span>
            <span class="n">was_success</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">BUILD_SUCCESS_VALUE</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">was_success</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_name</span><span class="si">}</span><span class="s2">: SUCCESSFUL&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{task}</span><span class="s2">_</span><span class="si">{results}</span><span class="s2">.log&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task_name</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="p">(</span>
                <span class="s2">&quot;SUCCESS&quot;</span> <span class="k">if</span> <span class="n">was_success</span> <span class="k">else</span> <span class="s2">&quot;ERROR&quot;</span><span class="p">)))</span>
            <span class="n">log_to_file</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">apps_list</span></div>

<div class="viewcode-block" id="GradleBuilder.uninstall_all_apks"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.uninstall_all_apks">[docs]</a>    <span class="k">def</span> <span class="nf">uninstall_all_apks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;uninstall all project apks.&quot;&quot;&quot;</span>
        <span class="n">task_name</span> <span class="o">=</span> <span class="s2">&quot;uninstallAll&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="n">task_name</span><span class="p">)</span></div>

<div class="viewcode-block" id="GradleBuilder.create_app_from_installed_apk"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.create_app_from_installed_apk">[docs]</a>    <span class="k">def</span> <span class="nf">create_app_from_installed_apk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradle_output</span><span class="p">,</span> <span class="n">build_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;create App object from installed apk on device.</span>
<span class="sd">        Args:</span>
<span class="sd">            gradle_output: build output.</span>
<span class="sd">            build_type: build type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            app(App): created app.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">installed_apk_simple_name</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;Installing APK \&#39;(.*?)\&#39;&quot;</span><span class="p">,</span> <span class="n">gradle_output</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">full_apk_path</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">installed_apk_simple_name</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">(</span><span class="n">build_type</span><span class="o">=</span><span class="n">build_type</span><span class="p">)),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">(</span><span class="n">build_type</span><span class="o">=</span><span class="n">build_type</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">new_pkgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_new_installed_pkgs</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_pkgs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># app was already installed</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;app already installed&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="n">app_pack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_package_matching</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">pkg_name</span><span class="p">)</span>
            <span class="n">new_pkgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">app_pack</span><span class="p">)</span>
        <span class="n">apk_pkg</span> <span class="o">=</span> <span class="n">new_pkgs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># ASSUMING JUST ONE</span>
        <span class="n">app</span> <span class="o">=</span> <span class="n">App</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="n">apk_pkg</span><span class="p">,</span> <span class="n">apk_path</span><span class="o">=</span><span class="n">full_apk_path</span><span class="p">,</span> <span class="n">local_res_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">results_dir</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">app</span></div>

<div class="viewcode-block" id="GradleBuilder.sign_apks"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.sign_apks">[docs]</a>    <span class="k">def</span> <span class="nf">sign_apks</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_type</span><span class="o">=</span><span class="n">BUILD_TYPE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sign project apks of build_type.</span>
<span class="sd">        Args:</span>
<span class="sd">            build_type: build type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if success, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_last_build_successful</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;sign&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">build_type</span> <span class="o">==</span> <span class="n">BUILD_TYPE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">for</span> <span class="n">apk_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">(</span><span class="n">build_type</span><span class="p">):</span>
            <span class="n">ret</span><span class="p">,</span> <span class="n">o</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">sign_apk</span><span class="p">(</span><span class="n">apk_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="s2">&quot;APK Successfully signed&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">loge</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error signing apk </span><span class="si">{</span><span class="n">apk_path</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GradleBuilder.build_apk"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.build_apk">[docs]</a>    <span class="k">def</span> <span class="nf">build_apk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_type</span><span class="o">=</span><span class="n">BUILD_TYPE</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build apk of build_type.</span>
<span class="sd">        Args:</span>
<span class="sd">            build_type: build type.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if success, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;assemble</span><span class="si">{</span><span class="n">build_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_last_build_successful</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_rebuild</span><span class="p">():</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Not building again </span><span class="si">{</span><span class="n">build_type</span><span class="si">}</span><span class="s2">. Last build was successful&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">apks_built</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
        <span class="n">was_success</span> <span class="o">=</span> <span class="n">BUILD_SUCCESS_VALUE</span> <span class="ow">in</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">was_success</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;BUILD (</span><span class="si">{</span><span class="n">build_type</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2">) SUCCESSFUL&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regist_successful_build</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">apks_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">()</span>
            <span class="n">fresh_apks</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">apks_now</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apks_built</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">apk</span> <span class="ow">in</span> <span class="n">fresh_apks</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">build_type</span> <span class="o">==</span> <span class="n">BUILD_TYPE</span><span class="o">.</span><span class="n">RELEASE</span><span class="p">:</span>
                    <span class="n">sign_apk</span><span class="p">(</span><span class="n">apk</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">add_apk</span><span class="p">(</span><span class="n">apk</span><span class="p">,</span> <span class="n">build_type</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Error Building APK&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GradleBuilder.build_tests_apk"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.build_tests_apk">[docs]</a>    <span class="k">def</span> <span class="nf">build_tests_apk</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;builds tests apk.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if success, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">task</span> <span class="o">=</span> <span class="s2">&quot;assembleAndroidTest&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_last_build_successful</span><span class="p">(</span><span class="n">task</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_rebuild</span><span class="p">():</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Not building again. Last build was successful&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="n">apks_built</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">()</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
        <span class="n">was_success</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">val</span> <span class="o">|</span> <span class="n">grep</span><span class="p">(</span><span class="n">BUILD_SUCCESS_VALUE</span><span class="p">))</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">was_success</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">: SUCCESSFUL&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regist_successful_build</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="n">apks_now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">get_apks</span><span class="p">()</span>
            <span class="n">apks_test</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">apks_now</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apks_built</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">apks_test</span> <span class="ow">in</span> <span class="n">apks_test</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">add_apk</span><span class="p">(</span><span class="n">apks_test</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Error Building test APK&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="GradleBuilder.build"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rebuild</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;builds project if project is not build yet or rebuild is True.</span>
<span class="sd">        Args:</span>
<span class="sd">            rebuild: True if the project has to be rebuilt.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if success, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">was_last_build_successful</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rebuild</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="s2">&quot;Not building again. Last build was successful&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="s2">&quot;clean&quot;</span><span class="p">)</span><span class="c1"># mainly to ensure that built apks from original proj do not persist</span>
        <span class="k">for</span> <span class="n">mod_name</span><span class="p">,</span> <span class="n">proj_module</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">bld_file</span> <span class="o">=</span> <span class="n">proj_module</span><span class="o">.</span><span class="n">build_file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__set_build_tools_version</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_or_update_dexoptions</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_or_update_lintoptions</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_plugins</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">needs_min_sdk_upgrade</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adapt_target_sdk_upgrade</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__update_test_instrumentation_runner</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_external_libs_fldr</span><span class="p">(</span><span class="n">proj_module</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_external_libs</span><span class="p">(</span><span class="n">proj_module</span><span class="p">)</span>
            <span class="c1"># maybe change build tools?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_build_classpaths</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_external_libs_to_repositories</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_or_replace_local_properties_files</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_with_gradlew</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;build_fail_retries&quot;</span><span class="p">,</span> <span class="n">DEFAULT_BUILD_TIMES_TO_TRY</span><span class="p">))</span></div>

<div class="viewcode-block" id="GradleBuilder.build_with_gradlew"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.build_with_gradlew">[docs]</a>    <span class="k">def</span> <span class="nf">build_with_gradlew</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="n">DEFAULT_BUILD_TIMES_TO_TRY</span><span class="p">,</span> <span class="n">target_task</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;performs build task with gradle.</span>
<span class="sd">        Args:</span>
<span class="sd">            tries: number max of tries to fix build errors.</span>
<span class="sd">            target_task: task to perform.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if success, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_gradle_wrapper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">has_gradle_wrapper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">has_gradle_wrapper</span><span class="p">:</span>
            <span class="c1"># create gradle wrapper</span>
            <span class="n">copy</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources_dir</span><span class="p">,</span> <span class="s2">&quot;build&quot;</span><span class="p">,</span> <span class="s2">&quot;gradle&quot;</span><span class="p">,</span> <span class="s2">&quot;gradlew&quot;</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__execute_gradlew_task</span><span class="p">(</span><span class="n">target_task</span><span class="p">)</span>
        <span class="n">was_success</span> <span class="o">=</span> <span class="n">BUILD_SUCCESS_VALUE</span> <span class="ow">in</span> <span class="n">val</span>
        <span class="k">if</span> <span class="n">was_success</span><span class="p">:</span>
            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_task</span><span class="si">}</span><span class="s2">: BUILD SUCCESSFUL&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">SUCCESS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">regist_successful_build</span><span class="p">(</span><span class="n">target_task</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">is_known_error</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">tries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">solve_known_error</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">error_msg</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;build-tools&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_tools_version</span><span class="p">})</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_task</span><span class="si">}</span><span class="s2">: BUILD FAILED. error is known (</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">). Fixing error and retrying&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
                <span class="n">log_to_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s2">&quot;registered_errors.log&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_with_gradlew</span><span class="p">(</span><span class="n">tries</span><span class="o">=</span><span class="n">tries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">target_task</span><span class="o">=</span><span class="n">target_task</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
                <span class="n">loge</span><span class="p">(</span><span class="s2">&quot;Unable to solve Building error&quot;</span><span class="p">)</span>
                <span class="n">log_to_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="se">\n</span><span class="s2">-------&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s2">&quot;unknown_errors.log&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__execute_gradlew_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;execute gradle task with gradle wrapper.</span>
<span class="sd">        Args:</span>
<span class="sd">            task: task name.</span>

<span class="sd">        Returns:</span>
<span class="sd">            str: command output.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing Gradle task: </span><span class="si">{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
        <span class="n">build_timeout_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span><span class="s2">&quot;build_timeout&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">build_timeout</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;timeout </span><span class="si">{</span><span class="n">build_timeout_val</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">if</span> <span class="n">build_timeout_val</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">execute_shell_command</span><span class="p">(</span>
            <span class="s2">&quot;cd </span><span class="si">{projdir}</span><span class="s2">; chmod +x gradlew ; </span><span class="si">{build_timeout}</span><span class="s2"> ./gradlew </span><span class="si">{task}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">projdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">,</span> <span class="n">build_timeout</span><span class="o">=</span><span class="n">build_timeout</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="s2">&quot;error running gradle task&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">errors</span>

<div class="viewcode-block" id="GradleBuilder.needs_min_sdk_upgrade"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.needs_min_sdk_upgrade">[docs]</a>    <span class="k">def</span> <span class="nf">needs_min_sdk_upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradle_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;infers if module needs min sdk upgrade in order to the app be installed on the current device.</span>
<span class="sd">        Args:</span>
<span class="sd">            gradle_file: gradle file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_min_sdk</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">)</span> <span class="o">|</span> <span class="n">grep</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;minSdkVersion.*[0-9]+&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">has_min_sdk</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">min_sdk</span> <span class="o">=</span> <span class="n">has_min_sdk</span> <span class="o">|</span> <span class="n">sed</span><span class="p">(</span><span class="s1">&#39;minSdkVersion| |=|</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">head</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">device_sdk_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_device_sdk_version</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">min_sdk</span><span class="p">))</span> <span class="o">&gt;</span> <span class="n">device_sdk_version</span><span class="p">:</span>
                <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This app target sdk version </span><span class="si">{</span><span class="n">min_sdk</span><span class="si">}</span><span class="s2">. This is greater than the device version and the application&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; might not work properly on the connected device&quot;</span><span class="p">,</span> <span class="n">log_sev</span><span class="o">=</span><span class="n">LogSeverity</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
                <span class="n">new_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;minSdkVersion (.+)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;minSdkVersion </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">device_sdk_version</span><span class="p">,</span>
                                  <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">)))</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
                    <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GradleBuilder.adapt_target_sdk_upgrade"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.adapt_target_sdk_upgrade">[docs]</a>    <span class="k">def</span> <span class="nf">adapt_target_sdk_upgrade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradle_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adapts target sdk upgrade to connected device if needed.</span>
<span class="sd">        Args:</span>
<span class="sd">            gradle_file: gradle file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_target_sdk</span> <span class="o">=</span> <span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">)</span> <span class="o">|</span> <span class="n">grep</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;targetSdkVersion.*[0-9]+&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">has_target_sdk</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">device_target_sdk_version</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_device_sdk_version</span><span class="p">()</span>
            <span class="n">new_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;targetSdkVersion (.+)&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;targetSdkVersion </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">device_target_sdk_version</span><span class="p">,</span>
                              <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">)))</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span></div>

    <span class="k">def</span> <span class="nf">__add_or_update_dexoptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradle_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds dexoptions to build file if needed.</span>
<span class="sd">        Args:</span>
<span class="sd">            gradle_file: gradle file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_dex_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">file_ctent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">))</span>
        <span class="c1">#has_android = re.search(r&#39;android.*?\{&#39;, file_ctent)</span>
        <span class="n">has_android</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;android[^\w]*?\{&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_android</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">has_dex_options</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dexOptions.*?\{&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_dex_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_dex_options</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dexOptions.*?\{([^}]+)&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">new_dex_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_opts</span><span class="p">(</span><span class="n">original_dex_options</span><span class="p">,</span> <span class="n">DEX_OPTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">DEX_OPTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_dex_opts</span><span class="p">[</span><span class="n">dx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">DEX_OPTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_dex_opts</span><span class="p">[</span><span class="n">dx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dval</span><span class="p">)</span>
        <span class="c1"># build string for adding to dexoptions</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">new_dex_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s%s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;android {</span><span class="se">\n\t</span><span class="s2">dexOptions {</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">line</span>
        <span class="n">fl_without_dexopts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;dexOptions.*?\{([^</span><span class="si">{}</span><span class="s1">]+)}&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="n">fl_ok</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;android[^\w]*?\{&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">fl_without_dexopts</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fl_ok</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_or_update_lintoptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradle_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Adds lint options.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_lint_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">file_ctent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">))</span>
        <span class="n">has_android</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;android[^\w]*?\{&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_android</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">has_lint_options</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;lintOptions.*?\{&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_lint_options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">original_lint_options</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;lintOptions.*?\{([^</span><span class="si">{}</span><span class="s1">]+)}&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">new_lint_opts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__filter_opts</span><span class="p">(</span><span class="n">original_lint_options</span><span class="p">,</span> <span class="n">LINT_OPTIONS</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">LINT_OPTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_lint_opts</span><span class="p">[</span><span class="n">dx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dval</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">dx</span><span class="p">,</span> <span class="n">dval</span> <span class="ow">in</span> <span class="n">LINT_OPTIONS</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_lint_opts</span><span class="p">[</span><span class="n">dx</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">dval</span><span class="p">)</span>
        <span class="c1"># build string for adding to dexoptions</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">new_lint_opts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\t\t</span><span class="si">%s%s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;android {</span><span class="se">\n\t</span><span class="s2">lintOptions {</span><span class="se">\n</span><span class="si">%s</span><span class="se">\t</span><span class="s2">}&quot;</span> <span class="o">%</span> <span class="n">line</span>
        <span class="n">fl_without_dexopts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;lintOptions.*?\{([^</span><span class="si">{}</span><span class="s1">]+)}&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="n">fl_ok</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;android[^\w]*?\{&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">fl_without_dexopts</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">fl_ok</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__update_test_instrumentation_runner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradle_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Updates test runner according to device sdk version.</span>
<span class="sd">        Args:</span>
<span class="sd">            gradle_file: gradle file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_ctent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">))</span>
        <span class="n">has_inst_runner</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;testInstrumentationRunner&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">has_inst_runner</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">contains_androidx_dependency</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;androidx\.test\.*&#39;</span><span class="p">,</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="n">device_sdk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">get_device_sdk_version</span><span class="p">()</span> <span class="k">if</span> <span class="n">contains_androidx_dependency</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">100</span>
        <span class="n">adequate_test_runner</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">device_sdk</span><span class="p">,</span> <span class="n">TEST_RUNNERS</span><span class="o">.</span><span class="n">items</span><span class="p">()))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_file</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;testInstrumentationRunner (.+)&quot;</span><span class="p">,</span>
                          <span class="sa">r</span><span class="s2">&quot;testInstrumentationRunner &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span> <span class="o">%</span> <span class="n">adequate_test_runner</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">file_ctent</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">gradle_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__filter_opts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opts</span><span class="p">,</span> <span class="n">excluding_set</span><span class="p">):</span>
        <span class="n">to_keep</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">dex_op</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">:</span>
            <span class="n">opt_tpls</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;(.*?)(=|\s|:)([^</span><span class="si">{}</span><span class="s1">]+)&#39;</span><span class="p">,</span> <span class="n">dex_op</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span><span class="o">.</span><span class="n">groups</span><span class="p">()</span>
            <span class="n">opt_key</span> <span class="o">=</span> <span class="n">opt_tpls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">opt_oper</span> <span class="o">=</span> <span class="n">opt_tpls</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">opt_val</span> <span class="o">=</span> <span class="n">opt_tpls</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">opt_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluding_set</span><span class="p">:</span>
                <span class="n">to_keep</span><span class="p">[</span><span class="n">opt_key</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">opt_oper</span><span class="p">,</span> <span class="n">opt_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">change_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Removed or replaced opt </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">opt_key</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">to_keep</span>

    <span class="k">def</span> <span class="nf">__add_or_replace_local_properties_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update or create local.properties file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">local_props_files</span> <span class="o">=</span> <span class="n">mega_find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;local.properties&quot;</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">custom_prop_file_ctent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_local_properties_file</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">loc_prop</span> <span class="ow">in</span> <span class="n">local_props_files</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">loc_prop</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">custom_prop_file_ctent</span><span class="p">)</span>
                <span class="n">u</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<div class="viewcode-block" id="GradleBuilder.build_local_properties_file"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.build_local_properties_file">[docs]</a>    <span class="k">def</span> <span class="nf">build_local_properties_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;builds local.properties file content.</span>
<span class="sd">        Returns:</span>
<span class="sd">            str: file content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                sdk.dir=</span><span class="si">{android_home}</span><span class="s1"></span>
<span class="s1">                sdk-location=</span><span class="si">{android_home}</span><span class="s1"></span>
<span class="s1">                ndk.dir=</span><span class="si">{android_home}</span><span class="s1">/ndk-bundle</span>
<span class="s1">                ndk-location=</span><span class="si">{android_home}</span><span class="s1">/ndk-bundle&#39;&#39;&#39;</span> \
            <span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">android_home</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">android_home_dir</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__add_external_libs_to_repositories</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_external_lib_dependency</span><span class="p">():</span>
            <span class="n">file_ctent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">root_build_file</span><span class="p">))</span>
            <span class="n">new_file</span> <span class="o">=</span> <span class="n">file_ctent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">allprojects {repositories {flatDir { dirs &#39;libs&#39;}}}&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">root_build_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
                <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_external_libs_fldr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds folder to include local 3rd party libs.</span>
<span class="sd">        Args:</span>
<span class="sd">            proj_module(obj:ProjectModule): project module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bld_file</span> <span class="o">=</span> <span class="n">proj_module</span><span class="o">.</span><span class="n">build_file</span>
        <span class="k">if</span> <span class="n">bld_file</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">root_build_file</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">needs_external_dependencies</span><span class="p">():</span>
            <span class="c1"># create folder</span>
            <span class="n">created_dir</span> <span class="o">=</span> <span class="n">proj_module</span><span class="o">.</span><span class="n">create_inner_folder</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;libs&quot;</span><span class="p">)</span>
            <span class="c1"># copy external lib to folder</span>
            <span class="n">lib_filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">profiler</span><span class="o">.</span><span class="n">local_dep_location</span>
            <span class="n">copy</span><span class="p">(</span><span class="n">lib_filepath</span><span class="p">,</span> <span class="n">created_dir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_external_libs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proj_module</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds dependencies to module.</span>
<span class="sd">        Args:</span>
<span class="sd">            proj_module(obj:ProjectModule): project module.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bld_file</span> <span class="o">=</span> <span class="n">proj_module</span><span class="o">.</span><span class="n">build_file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">needs_external_lib_dependency</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">file_ctent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">bld_file</span><span class="p">))</span>
        <span class="n">dependencies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">get_build_dependencies</span><span class="p">()</span>
        <span class="c1">#has_depts = re.search(r&#39;dependencies.*?\{(.|\n)*}&#39;, file_ctent).group(0)</span>
        <span class="n">new_deps</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">dependencies{</span><span class="se">\n\t</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">n_dp</span> <span class="ow">in</span> <span class="n">dependencies</span><span class="p">:</span>
            <span class="n">new_deps</span> <span class="o">+=</span> <span class="n">gen_dependency_string</span><span class="p">(</span><span class="n">n_dp</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span>
        <span class="n">new_file_ctent</span> <span class="o">=</span> <span class="n">file_ctent</span> <span class="o">+</span> <span class="n">new_deps</span> <span class="o">+</span> <span class="s2">&quot;}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bld_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file_ctent</span><span class="p">)</span>

<div class="viewcode-block" id="GradleBuilder.needs_external_lib_dependency"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.needs_external_lib_dependency">[docs]</a>    <span class="k">def</span> <span class="nf">needs_external_lib_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;needs build dependencies from instrumenter.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if needs, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">needs_build_dependency</span><span class="p">()</span></div>

<div class="viewcode-block" id="GradleBuilder.was_last_build_successful"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.was_last_build_successful">[docs]</a>    <span class="k">def</span> <span class="nf">was_last_build_successful</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;checks if last build attempt was successful.</span>
<span class="sd">        inspects BUILD_RESULTS_FILE file and checks build result.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if build was successful, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="n">BUILD_RESULTS_FILE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
                <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">js</span><span class="p">[</span><span class="n">task</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="n">SUCCESS_VALUE</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">if</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">js</span> <span class="k">else</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="GradleBuilder.regist_successful_build"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.regist_successful_build">[docs]</a>    <span class="k">def</span> <span class="nf">regist_successful_build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="s2">&quot;build&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;record successful build in file.</span>
<span class="sd">        Args:</span>
<span class="sd">            task: build task name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="n">BUILD_RESULTS_FILE</span><span class="p">)</span>
        <span class="n">js</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fl</span><span class="p">:</span>
                <span class="n">js</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fl</span><span class="p">)</span>

        <span class="n">js</span><span class="p">[</span><span class="n">task</span><span class="p">]</span> <span class="o">=</span> <span class="n">SUCCESS_VALUE</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">js</span><span class="p">,</span> <span class="n">outfile</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">__set_build_tools_version</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bld_file</span><span class="p">,</span> <span class="n">btools_version</span><span class="o">=</span><span class="n">DEFAULT_BUILD_TOOLS_VERSION</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;sets build tools version btools_version on bld_file.</span>
<span class="sd">        Args:</span>
<span class="sd">            bld_file: build file.</span>
<span class="sd">            btools_version: version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">has_bld_tools</span> <span class="o">=</span> <span class="nb">str</span><span class="p">((</span><span class="n">cat</span><span class="p">(</span><span class="n">bld_file</span><span class="p">)</span> <span class="o">|</span> <span class="n">grep</span><span class="p">(</span><span class="s2">&quot;buildToolsVersion&quot;</span><span class="p">)</span> <span class="o">|</span> <span class="n">sed</span><span class="p">(</span><span class="s2">&quot;buildToolsVersion|</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">has_bld_tools</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">can_be_semantic_version</span><span class="p">(</span><span class="n">has_bld_tools</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_tools_version</span> <span class="o">=</span> <span class="n">DefaultSemanticVersion</span><span class="p">(</span><span class="n">has_bld_tools</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">elif</span> <span class="s2">&quot;ext.&quot;</span> <span class="ow">in</span> <span class="n">has_bld_tools</span><span class="p">:</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="n">has_bld_tools</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;ext.&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">target_pattern1</span><span class="p">,</span> <span class="n">target_pattern2</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;ext.*?\{&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.*?=.*&#39;</span> <span class="o">%</span> <span class="n">var_name</span>
                <span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">target_pattern1</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">target_pattern2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">t</span><span class="p">))),</span> <span class="n">mega_find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="s2">&quot;*.gradle&quot;</span><span class="p">,</span> <span class="n">type_file</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">)))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># assume 0</span>
                    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\&quot;|</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">target_pattern2</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span><span class="o">.</span><span class="n">group</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">if</span> <span class="n">can_be_semantic_version</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">build_tools_version</span> <span class="o">=</span> <span class="n">DefaultSemanticVersion</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                        <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logw</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unable to determinate build tools version. Using default: </span><span class="si">{</span><span class="n">btools_version</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">build_tools_version</span> <span class="o">=</span> <span class="n">DefaultSemanticVersion</span><span class="p">(</span><span class="n">btools_version</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bld_file</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds build plugins if needed</span>
<span class="sd">        Args:</span>
<span class="sd">            bld_file: build file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">needs_build_plugin</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">file_content</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="n">bld_file</span><span class="p">))</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">get_build_plugins</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">plugins</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">plugins</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">file_content</span><span class="p">:</span>

            <span class="k">return</span>
        <span class="n">has_plugin_apply</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;apply.*plugin.*&#39;</span><span class="p">,</span> <span class="n">file_content</span><span class="p">)</span>
        <span class="n">plg_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">if</span> <span class="n">has_plugin_apply</span><span class="p">:</span>
            <span class="c1"># replace</span>
            <span class="c1"># plgs = echo(file_content) | grep(r&#39;apply.*plugin&#39;)</span>
            <span class="c1"># it can&#39;t be the first plugin</span>
            <span class="n">plgs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;apply.*plugin.*&#39;</span><span class="p">,</span> <span class="n">file_content</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;hunter&#39;</span> <span class="ow">in</span> <span class="n">plg</span> <span class="ow">and</span> <span class="n">is_library_gradle</span><span class="p">(</span><span class="n">bld_file</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">plg_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;apply plugin: &#39;</span><span class="si">{</span><span class="n">plg</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="c1"># file_content = re.sub(plgs, (plg_string + plgs), file_content)</span>
            <span class="n">last_plg</span> <span class="o">=</span> <span class="n">plgs</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">plgs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">new_plgs</span> <span class="o">=</span> <span class="n">last_plg</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">plg_string</span>
            <span class="n">file_content</span> <span class="o">=</span> <span class="n">file_content</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">last_plg</span><span class="p">,</span> <span class="n">new_plgs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">has_plugins</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;plugins.*\{&#39;</span><span class="p">,</span> <span class="n">file_content</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">has_plugins</span><span class="p">:</span>
                <span class="n">original_plugs</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;plugins.*?\{([^</span><span class="si">{}</span><span class="s1">]+)}&#39;</span><span class="p">,</span> <span class="n">file_content</span><span class="p">)</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
                    <span class="n">plg_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">id &#39;</span><span class="si">{</span><span class="n">plg</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">file_content</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">original_plugs</span><span class="p">,</span> <span class="n">original_plugs</span> <span class="o">+</span> <span class="n">plg_string</span><span class="p">,</span> <span class="n">file_content</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># append at beginning</span>
                <span class="k">for</span> <span class="n">plg</span> <span class="ow">in</span> <span class="n">plugins</span><span class="p">:</span>
                    <span class="n">plg_string</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;apply plugin: &#39;</span><span class="si">{</span><span class="n">plg</span><span class="si">}</span><span class="s2">&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">file_content</span> <span class="o">=</span> <span class="n">plg_string</span> <span class="o">+</span> <span class="n">file_content</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">bld_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_content</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__add_build_classpaths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;adds build dependencies of the instrumenter if needed.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">needs_build_classpaths</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="n">file_ctent</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">root_build_file</span><span class="p">))</span>
        <span class="c1"># TODO: more elegant way to do this, instead of just appending to build file</span>
        <span class="n">classpaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">instrumenter</span><span class="o">.</span><span class="n">get_build_classpaths</span><span class="p">()</span>
        <span class="n">pato_str</span> <span class="o">=</span> <span class="s2">&quot;buildscript{</span><span class="se">\n\t</span><span class="s2">dependencies{</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">pato</span> <span class="ow">in</span> <span class="n">classpaths</span><span class="p">:</span>
            <span class="n">pato_str</span> <span class="o">+=</span> <span class="n">gen_dependency_string</span><span class="p">(</span><span class="n">pato</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">new_file_ctnt</span> <span class="o">=</span> <span class="n">file_ctent</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">pato_str</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">}</span><span class="se">\n</span><span class="s2">}&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">root_build_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">u</span><span class="p">:</span>
            <span class="n">u</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">new_file_ctnt</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__has_built_apks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;checks if project has apks already built.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if has, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">mega_find</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proj</span><span class="o">.</span><span class="n">proj_dir</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;*.apk&quot;</span><span class="p">,</span> <span class="n">type_file</span><span class="o">=</span><span class="s1">&#39;f&#39;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span>

<div class="viewcode-block" id="GradleBuilder.needs_rebuild"><a class="viewcode-back" href="../../../anadroid.build.html#anadroid.build.GradleBuilder.GradleBuilder.needs_rebuild">[docs]</a>    <span class="k">def</span> <span class="nf">needs_rebuild</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;checks if project needs rebuild.</span>
<span class="sd">        Returns:</span>
<span class="sd">            bool: True if needs, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__has_built_apks</span><span class="p">()</span>  <span class="c1"># TODO check build type and maybe last build output, lint, etc</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Rui Rua.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>